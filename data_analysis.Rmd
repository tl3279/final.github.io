---
title: "Data Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
library(tidyverse)
library(haven)
library(readxl)
library(plotly)
library(sf)
library(VGAM)
```

**Data Importing, Cleaning and Selecting**
```{r}
brfss_22 = read_csv("NYSDOH_BRFSS_Survey_Data_2022.csv")|>
  janitor::clean_names()
```

```{r}
zipcode = 
  brfss_22 |>
  filter(zipcode1 != "Data do not meet the criteria for statistical reliability, data quality or confidentiality (data are suppressed)")

head(zipcode)
```

```{r}
county = 
  brfss_22 |>
  filter(ctycode2 != "Data do not meet the criteria for statistical reliability, data quality or confidentiality (data are suppressed)")

head(county)
```
· we try to filter people who live in NYC, but all data are confidential. 


**Subset Dataset Cleaning**
```{r}
cleaned_df = 
  brfss_22 |>
  filter(complete.cases(imprace, educag, incomg1, strsmeal_sa, genhlth))|>
  select(imprace, educag, incomg1, strsmeal_sa, genhlth)
```

```{r}
cleaned_df = 
  cleaned_df |>
  mutate(
    income = case_when(
      incomg1 %in% c("Less than $15,000", "$25,000 to < $35,000", "$35,000 to < $50,000") ~"<50,000",
      incomg1 == "$50,000 to < $100,000" ~ "50,000 ~ 100,000",
      incomg1 %in% c ("$100,000 to < $200,000" , "$200,000 or more") ~ ">100,000",
      TRUE ~ NA_character_),
    
    education = case_when(
      educag == "Did not graduate High School" ~ "Less than high school",
      educag == "Graduated High School" ~ "High school or GED",
      educag == "Attended College or Technical School" ~ "Some post-high school",
      educag == "Graduated from College or Technical School" ~ "College graduate"
    ),
    
    food_insecure = case_when(
      strsmeal_sa %in% c("Rarely","Sometimes","Usually", "Always") ~ 1,
      strsmeal_sa == "Never" ~ 0)
   )|>
  filter(!is.na(income), !is.na(education))|>
  select(-incomg1, -educag, -strsmeal_sa)

```

### Cleaning Step:
· First filtering all valid values in the following variables: imprace, educag, incomg1, strsmeal_sa, genhlth.

· Only selecting these variables that we will use in the following steps because the original dataset is too       large. It is easy to make a subset dataset. 

· After first step filtering, we re-categorize income3, educag, and strsmeal_sa. The most noticeable change is     re-categorizing strsmeal_sa into a new variable "food-insecure". We combine rarely, sometimes, usually, and      always into "1" to represent food insecure challenge that individuals face, and contain never as 0 to represent   no food insecure. 

· Last, we remove all missing values from the sub dataset. 



**Figures Making**

```{r}
ggplot(data = cleaned_df, aes(x = imprace, fill = imprace))+
  geom_bar() +
  labs(
    title = "Distribution of Race/Ethnicity",
    x = "Race/Ethnicity",
    y = "Count"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```



This bar graph illustrates the distribution of race/ethnicity in the dataset. The categories include American Indian/Alaskan Native, Asian, Black, Hispanic, Other Race, and White, all specified as Non-Hispanic except for the Hispanic group. Among these groups, White, Non-Hispanic individuals dominate, with the highest count exceeding 6,000. The second most prevalent group is Hispanic, followed by Black, Non-Hispanic, while Other Race, Non-Hispanic, and Asian, Non-Hispanic, show significantly smaller counts. The American Indian/Alaskan Native, Non-Hispanic category represents the smallest group. 


```{r}
ggplot(cleaned_df, aes(x = "", fill = education)) +
  geom_bar(width = 1, stat = "count") +
  coord_polar(theta = "y") +
  labs(
    title = "Distribution of Education Levels",
    fill = "Education Level"
  ) +
  theme_void() +
  theme(legend.position = "right")
```




This pie chart shows the distribution of education levels within a dataset. The largest portion of the chart is represented by college graduates, shown in red, indicating that a significant proportion of individuals have completed higher education. The second-largest category, represented in purple, corresponds to individuals with some post-high school education. High school graduates or those with a GED, shown in green, form a smaller segment, while the smallest portion of the chart, in teal, represents individuals with less than a high school education. 


```{r}
ggplot(cleaned_df, aes(x = as.factor(food_insecure), fill = as.factor(food_insecure))) +
  geom_bar() +
  scale_fill_manual(values = c("0" = "lightblue", "1" = "pink"), labels = c("Not Food Insecure", "Food Insecure")) +
  labs(
    title = "Distribution of Food Insecurity",
    x = "Food Insecurity",
    y = "Count",
    fill = "Status"
  ) +
  theme_minimal()
```




This bar graph presents the distribution of food insecurity status among individuals in the dataset. The largest group, represented in light blue, comprises individuals who are not food insecure, with a count exceeding 4,000. The second-largest group, shown in pink, represents individuals who are food insecure, numbering slightly over 2,000. A very small proportion, represented in gray, corresponds to missing data (NA) for food insecurity status. 


```{r}
cleaned_df = 
  cleaned_df |>
  mutate(
    imprace = as.factor(imprace),
    income = as.factor(income),
    education = as.factor(education),
    genhlth = as.factor(genhlth)
  )
```


## **Logistic Regression Models**

### Is income associated with food insecure? 
```{r}
logit_income = 
  glm(formula = food_insecure ~ income, data = cleaned_df, family = binomial)
```

```{r}
summary(logit_income)
```

```{r}
exp_income = exp(cbind(OR=coef(logit_income),confint(logit_income)))

knitr::kable(exp_income)
```

### Confidence Interval
```{r}
ci_income = as.data.frame(exp_income)
ci_income = 
  ci_income |> 
  rownames_to_column("Variable") |> 
  filter(Variable != "(Intercept)") 
```

```{r}
ggplot(ci_income, aes(y = Variable, x = OR, xmin = `2.5 %`, xmax = `97.5 %`)) +
  geom_pointrange() +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") +
  labs(
    title = "Odds Ratios with 95% Confidence Intervals",
    x = "Odds Ratio (OR)",
    y = "Income Category"
  ) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 12))
```



### Is race associated with food insecure?
```{r}
logit_race = 
  glm(food_insecure ~ imprace, data = cleaned_df, family = binomial)
```

```{r}
summary(logit_race)
```

```{r}
exp_race = exp(cbind(OR=coef(logit_race),confint(logit_race)))

knitr::kable(exp_race)
```

### Confidence Interval
```{r}
ci_race = as.data.frame(exp_race)
ci_race = 
  ci_race |> 
  rownames_to_column("Variable") |> 
  filter(Variable != "(Intercept)") 
```

```{r}
ggplot(ci_race, aes(y = Variable, x = OR, xmin = `2.5 %`, xmax = `97.5 %`)) +
  geom_pointrange() +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") +
  labs(
    title = "Odds Ratios with 95% Confidence Intervals",
    x = "Odds Ratio (OR)",
    y = "Income Category"
  ) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 12))
```





### Is education associated with food insecure?
```{r}
logit_edu = 
  glm(food_insecure ~ education, data = cleaned_df, family = binomial)
```

```{r}
summary(logit_edu)
```

```{r}
exp_edu = exp(cbind(OR=coef(logit_edu),confint(logit_edu)))

knitr::kable(exp_edu)
```

### Confidence Interval
```{r}
ci_edu = as.data.frame(exp_edu)
ci_edu = 
  ci_edu |> 
  rownames_to_column("Variable") |> 
  filter(Variable != "(Intercept)") 
```

```{r}
ggplot(ci_edu, aes(y = Variable, x = OR, xmin = `2.5 %`, xmax = `97.5 %`)) +
  geom_pointrange() +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") +
  labs(
    title = "Odds Ratios with 95% Confidence Intervals",
    x = "Odds Ratio (OR)",
    y = "Income Category"
  ) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 12))
```



### Are race, education, and income associated with food insecure?
```{r}
logit_all = 
  glm(food_insecure ~ education + income + imprace, data = cleaned_df, family = binomial)
```

```{r}
summary(logit_all)
```

```{r}
exp_all = exp(cbind(OR=coef(logit_all),confint(logit_all)))

knitr::kable(exp_all)
```

### Confidence Interval
```{r}
ci_all = as.data.frame(exp_all)
ci_all = 
  ci_all |> 
  rownames_to_column("Variable") |> 
  filter(Variable != "(Intercept)") 
```

```{r}
ggplot(ci_all, aes(y = Variable, x = OR, xmin = `2.5 %`, xmax = `97.5 %`)) +
  geom_pointrange() +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") +
  labs(
    title = "Odds Ratios with 95% Confidence Intervals",
    x = "Odds Ratio (OR)",
    y = "Income Category"
  ) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 12))
```



### Is food insecure associated with general health?
```{r}
mlogit_health = 
  vglm(genhlth ~ food_insecure, data = cleaned_df, family = multinomial(refLevel = "Fair"))
```

```{r}
summary(mlogit_health)
```

```{r}
exp_health = exp(cbind(OR=coef(mlogit_health),confint(mlogit_health)))

knitr::kable(exp_health)
```


### Confidence Interval
```{r}
coefs <- coef(summary(mlogit_health))
odds_ratios <- exp(coefs[, "Estimate"]) # Convert coefficients to odds ratios
lower_ci <- exp(coefs[, "Estimate"] - 1.96 * coefs[, "Std. Error"]) # Lower 95% CI
upper_ci <- exp(coefs[, "Estimate"] + 1.96 * coefs[, "Std. Error"]) # Upper 95% CI

# Combine into a tidy data frame
ci_data <- data.frame(
  Variable = rownames(coefs),
  OR = odds_ratios,
  Lower = lower_ci,
  Upper = upper_ci
) |>
  filter(!grepl("(Intercept)", Variable)) |> # Exclude intercepts
  separate(Variable, into = c("Outcome", "Predictor"), sep = ": ", fill = "right")
```


```{r}
ggplot(ci_data, aes(y = Outcome, x = OR, xmin = Lower, xmax = Upper, color = Predictor)) +
  geom_pointrange() +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") +
  labs(
    title = "Odds Ratios with 95% Confidence Intervals",
    x = "Odds Ratio (OR)",
    y = "Outcome (General Health)",
    color = "Predictor"
  ) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 12))
```

