---
title: "Identifying Food Deserts"
output: 
  html_document:
    toc: false
    toc_float: true
    code_folding: hide
---

<br>   

## Data Importing and Cleaning   
Visit [this page](report.html) for detailed steps on how the data is cleaned.
```{r, include  = FALSE, warning= FALSE}
library(tidyverse)
library(sf)
library(dplyr)
library(tmap) 
library(readxl)
library(ggspatial)
library(prettymapr)
```

```{r warning = FALSE, message = FALSE}
population_data =
  read_excel("nyc2020_census_blocks.xlsx") |>
  slice(-c(1:6)) |>
  mutate(
    borough_code = as.numeric(substr(GeoID, 1, 1)), 
    tract_number = substr(GeoID, 2, 7),
    fips_county = case_when(
      borough_code == 1 ~ "061",
      borough_code == 2 ~ "005",
      borough_code == 3 ~ "047",
      borough_code == 4 ~ "081",
      borough_code == 5 ~ "085" 
    ),
    geoid = paste0("36", fips_county, tract_number)
  ) |>
  group_by(geoid) |>
  summarize(total_population = sum(Pop1, na.rm = TRUE)) 

nyc_tracts = 
  st_read(
    "2020 Census Tracts/geo_export_ae979acf-b46a-42af-a79f-874d7b450fc8.shp",
    quiet = TRUE)|>
  left_join(population_data, by = "geoid") |>
  mutate(
    pop_bins = cut(
      total_population,
      breaks = c(0, 1001, 5001, 10001, 15001, Inf),
      labels = c("≤ 1,000", "1,001 - 5,000", "5,001 - 10,000", "10,001 - 15,000", "> 15,000"),
      include.lowest = TRUE
    )
  ) |>
  select(boroname, total_population, geometry, pop_bins)

retail_stores = 
  read_csv("Retail_Food_Stores.csv") |>
  janitor::clean_names() |>
  filter(county %in% c("BRONX", "KINGS", "NEW YORK", "RICHMOND", "QUEENS"),
         !str_detect(establishment_type, "B|C|D")) |>
  mutate(county = recode(county,
    "BRONX" = "Bronx",
    "KINGS" = "Brooklyn",
    "NEW YORK" = "Manhattan",
    "RICHMOND" = "Staten Island",
    "QUEENS" = "Queens"
  )) |>
  mutate(geometry = st_as_sfc(georeference)) |>
  st_as_sf() |>
  st_set_crs(4326)

retail_stores =
  retail_stores |>
  filter(square_footage >= 2000) |>
  mutate(
    category = case_when(
      square_footage < 5000 ~ "Small",
      square_footage <= 9000 ~ "Medium",
      square_footage > 9000 ~ "Large"
    )
  )|>
  select(county, geometry, category)

covered_df = 
  retail_stores |>
  st_transform(crs = 2263) |>
  mutate(
    coverage_radius = case_when(
      category == "Small" ~ 5280*0.15,
      category == "Medium" ~ 5280*0.25,
      category == "Large" ~ 5280*0.35
    )
  ) |>
  mutate(geometry = st_buffer(geometry, dist = coverage_radius))
```

## NYC Population
This plot shows the population distribution across New York City's census tracts using data from the 2020 New York City Decennial Census Data. Manhattan exhibits the highest population density, with significant concentrations in its central and southern regions. In contrast, areas like Staten Island show comparatively lower population densities. 
```{r fig.height=8,fig.width=8, warning = FALSE, message = FALSE}
nyc_tracts |>
  ggplot() +
  annotation_map_tile(zoom = 12, type = "cartolight") +  
  geom_sf(aes(fill = pop_bins), color = "white", lwd = 0.2) +
  scale_fill_manual(
    values = c("#fee5d9", "#fcbba1", "#fc9272", "#fb6a4a", "#de2d26"),
    name = "Population by Census Tract"
  ) +
  labs(
    title = "Distribution of Population Density",
    subtitle = "New York City"
  ) +
  theme_minimal() +
  theme(
    legend.position = c(0.05, 0.9), 
    legend.justification = c(0, 1), 
    legend.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(size=17.5, hjust=0.5),
    plot.subtitle = element_text(hjust=.5)
  )
```

## Retail Stores Location  
To identify food deserts, we examined the distribution of retail stores across New York City. To enhance visualization and clarity, the analysis is divided into two geographic regions: **Manhattan + Bronx** and **Brooklyn + Queens + Staten Island**.  

### Manhattan and Bronx   
The map below depicts the locations of retail stores in Manhattan and the Bronx, plotted over a population density map by census tract.
```{r fig.height=8,fig.width=8, warning = FALSE, message = FALSE}
nyc_tracts |>
  filter(boroname %in% c("Manhattan", "Bronx")) |>
  ggplot() +
  annotation_map_tile(zoom = 12, type = "cartolight") + 
  geom_sf(aes(fill = pop_bins), color = "white", lwd = 0.2) +
  geom_sf(data = retail_stores |>
            filter(county %in% c("Manhattan", "Bronx")), color = "darkblue", size = 2) +
  scale_fill_manual(
    values = c("#fee5d9", "#fcbba1", "#fc9272", "#fb6a4a", "#de2d26"),
    name = "Population by Census Tract"
  ) +
  labs(
    title = "Population Distribution and Retail Store Locations",
    subtitle = "Manhattan and Bronx"
  ) +
  theme_minimal() +
  theme(
    legend.position = c(0.05, 0.9), 
    legend.justification = c(0, 1), 
    legend.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(size=17.5, hjust=0.5),
    plot.subtitle = element_text(hjust=.5)
  )
```

Retail stores are heavily concentrated in central and lower Manhattan, which aligns with areas of higher population density and commercial activity. The Bronx shows a more evenly distributed pattern of retail stores. However, northern and central Bronx census tracts with higher populations have fewer stores, indicating possible underserved areas.

We will add coverage zones that align with population density to highlight underserved areas that may require interventions to improve access to nutritious food.
```{r fig.height=8,fig.width=8, warning = FALSE, message = FALSE}
nyc_tracts |>
  filter(boroname %in% c("Manhattan", "Bronx")) |>
  ggplot() +
  annotation_map_tile(zoom = 12, type = "cartolight") + 
  geom_sf(aes(fill = pop_bins),
    color = "white", lwd = 0.2
  ) +
  geom_sf(
    data = covered_df |> filter(county %in% c("Manhattan", "Bronx")),
    aes(fill = category),
    alpha = 0.4,
    color = NA
  ) +
  geom_sf(
    data = retail_stores |> filter(county %in% c("Manhattan", "Bronx")),
    aes(color = category),
    alpha = 0.6,
    size = 1.5
  ) +
  scale_fill_manual(
    values = c(
      "Small" = "yellow", "Medium" = "green", "Large" = "blue",
      "≤ 1,000" = "#fee5d9", "1,001 - 5,000" = "#fcbba1",
      "5,001 - 10,000" = "#fc9272", "10,000 - 15,000" = "#fb6a4a",
      "> 15,000" = "#de2d26"
    ),
    breaks = c("Small", "Medium", "Large"), 
    name = "Store Category"
  ) +
  scale_color_manual(
    values = c("Small" = "yellow", "Medium" = "green", "Large" = "blue"),
    guide = "none"
  ) +
  labs(
    title = "Population Distribution and Retail Store Coverage",
    subtitle = "Manhattan and Bronx"
  ) +
  theme_minimal() +
  theme(
    legend.position = c(0.05, 0.9), 
    legend.justification = c(0, 1), 
    legend.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(size=17.5, hjust=0.5),
    plot.subtitle = element_text(hjust=.5)
  )
```

For Manhattan, overlapping coverage zones indicate high accessibility, suggesting these areas are well-served by retail options. For the Bronx, retail stores are less densely distributed, especially in the upper-left corner, where coverage zones are nearly absent. This highlights potential food desert areas with limited access to retail stores


### Brooklyn, Queens, and Staten Island   
In this visualization, the distribution of retail stores across Brooklyn, Queens, and Staten Island is shown overlaid on the population density map by census tract. 
```{r fig.height=8,fig.width=8, warning = FALSE, message = FALSE}
nyc_tracts |>
  filter(boroname %in% c("Brooklyn", "Queens", "Staten Island")) |>
  ggplot() +
  annotation_map_tile(zoom = 12, type = "cartolight") + 
  geom_sf(aes(fill = pop_bins), color = "white", lwd = 0.2) +
  geom_sf(data = retail_stores |>
            filter(county %in% c("Brooklyn", "Queens", "Staten Island")), color = "darkblue", size = 2) +
  scale_fill_manual(
    values = c("#fee5d9", "#fcbba1", "#fc9272", "#fb6a4a", "#de2d26"),
    name = "Population by Census Tract"
  ) +
  labs(
    title = "Population Distribution and Retail Store Locations",
    subtitle = "Brooklyn, Queens, and Staten Island"
  ) +
  theme_minimal() +
  theme(
    legend.position = c(0.05, 0.9), 
    legend.justification = c(0, 1),
    legend.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(size=17.5, hjust=0.5),
    plot.subtitle = element_text(hjust=.5)
  )
```

Brooklyn has a high density of retail stores, particularly in areas of moderate to high population density. 
Queens also displays significant coverage of retail stores, though there are noticeable gaps in the central and eastern parts of the borough. Staten Island has retail stores distributed relatively loosely, and the southernmost tracts with lower population density have limited retail store presence.

```{r fig.height=8,fig.width=8, warning = FALSE, message = FALSE}
nyc_tracts |>
  filter(boroname %in% c("Brooklyn", "Queens", "Staten Island")) |>
  ggplot() +
  annotation_map_tile(zoom = 12, type = "cartolight") + 
  geom_sf(aes(fill = pop_bins),
    color = "white", lwd = 0.2
  ) +
  geom_sf(
    data = covered_df |> 
      filter(county %in% c("Brooklyn", "Queens", "Staten Island")),
    aes(fill = category),
    alpha = 0.4,
    color = NA
  ) +
  geom_sf(
    data = retail_stores |> 
      filter(county %in% c("Brooklyn", "Queens", "Staten Island")),
    aes(color = category),
    alpha = 0.6,
    size = 1.5
  ) +
  scale_fill_manual(
    values = c(
      "Small" = "yellow", "Medium" = "green", "Large" = "blue",
      "≤ 1,000" = "#fee5d9", "1,001 - 5,000" = "#fcbba1",
      "5,001 - 10,000" = "#fc9272", "10,000 - 15,000" = "#fb6a4a",
      "> 15,000" = "#de2d26"
    ),
    breaks = c("Small", "Medium", "Large"), 
    name = "Store Category"
  ) +
  scale_color_manual(
    values = c("Small" = "yellow", "Medium" = "green", "Large" = "blue"),
    guide = "none"
  ) +
  labs(
    title = "Population and Retail Store Coverage",
    subtitle = "Brooklyn, Queens, and Staten Island"
  ) +
  theme_minimal() +
  theme(
    legend.position = c(0.05, 0.9),
    legend.justification = c(0, 1),
    legend.background = element_rect(fill = "white", color = "black"),
    plot.title = element_text(size=17.5, hjust=0.5),
    plot.subtitle = element_text(hjust=.5)
  )
```

For Brooklyn, the coverage zones overlap significantly in densely populated areas but small gaps remain in the eastern parts. Queens has a mix of small and medium store coverage, indicating moderate coverage. Sparse large store buffers in some areas leave room for improvement, especially in central and eastern Queens. For Staten Island, the southernmost and central tracts have very few store buffers, indicating potential food desert areas.